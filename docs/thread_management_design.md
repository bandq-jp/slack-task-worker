# Slackスレッド管理設計

## 🎯 目的

タスクに関連する全てのメッセージを**1つのスレッドにまとめる**ことで、以下を実現：
- タスクの履歴を一箇所で確認できる
- DMが散らからない
- タスクの状態遷移が分かりやすい
- コンテキストを保持した会話が可能

## 📊 現在のメッセージフロー分析

### タスクライフサイクルとメッセージ

```
1. タスク作成
   ├─ 依頼先（承認者）へDM: 承認リクエスト
   └─ 依頼者へDM: タスク作成通知（現在は実装なし）

2. タスク承認待ち（6時間経過）
   ├─ 依頼先（承認者）へDM: 承認リマインド
   └─ 依頼者へDM: 承認リマインド

3. タスク承認/差し戻し
   └─ 依頼者へDM: 承認/差し戻し通知

4. 納期リマインド（承認後）
   ├─ 期日前（24時間前）
   ├─ 当日
   └─ 超過

5. 延期申請
   └─ 依頼者（承認者）へDM: 延期申請通知

6. 延期承認待ち（6時間経過）
   ├─ 依頼者（承認者）へDM: 延期承認リマインド
   └─ 依頼先（申請者）へDM: 延期承認リマインド

7. 完了申請
   └─ 依頼者（承認者）へDM: 完了申請通知

8. 完了承認待ち（6時間経過）
   ├─ 依頼者（承認者）へDM: 完了承認リマインド
   └─ 依頼先（申請者）へDM: 完了承認リマインド
```

### 送信されるメッセージ（7種類）

| メソッド | タイミング | 送信先 | 目的 |
|---------|-----------|--------|------|
| `send_approval_request` | タスク作成時 | 依頼先 | 承認リクエスト |
| `send_task_reminder` | 納期接近/超過 | 依頼先 | 納期リマインド |
| `send_extension_request_to_requester` | 延期申請時 | 依頼者 | 延期申請通知 |
| `send_completion_request_to_requester` | 完了申請時 | 依頼者 | 完了申請通知 |
| `send_task_approval_reminder` | 承認待ち6時間経過 | 依頼先+依頼者 | タスク承認リマインド |
| `send_completion_approval_reminder` | 完了承認待ち6時間経過 | 依頼者+依頼先 | 完了承認リマインド |
| `send_extension_approval_reminder` | 延期承認待ち6時間経過 | 依頼者+依頼先 | 延期承認リマインド |

## 🎨 スレッド管理の設計

### 基本方針

**1つのタスク = 2つのスレッド**
- **依頼先（担当者）のスレッド**: 担当者のDMに作成
- **依頼者のスレッド**: 依頼者のDMに作成

各ユーザーは自分に関係するタスクのスレッドのみを見る。

### スレッドの親メッセージ（Thread Root）

**タスク作成時に送信する最初のメッセージ**がスレッドの親になる：

#### 依頼先（担当者）への親メッセージ
```
📋 新しいタスク: [タスク名]
依頼者: @依頼者名
納期: 2025-10-04 16:00
ステータス: 承認待ち

[承認] [差し戻し]
```

#### 依頼者への親メッセージ
```
✅ タスク依頼を送信しました: [タスク名]
依頼先: @担当者名
納期: 2025-10-04 16:00
ステータス: 承認待ち

承認待ちです。担当者の承認をお待ちください。
```

### スレッド内の返信メッセージ

すべての後続メッセージは**スレッドの返信**として送信：

#### 承認リマインド（スレッド返信）
```
⏰ リマインド: まだ承認待ちです
経過時間: 6時間

[承認] [差し戻し]
```

#### 承認通知（スレッド返信）
```
✅ タスクが承認されました
承認日時: 2025-10-03 18:00

納期までに完了してください。
```

#### 納期リマインド（スレッド返信）
```
⏰ 納期リマインド: 当日です
納期: 2025-10-04 16:00
残り: 2時間

[完了申請] [延期申請]
```

#### 完了申請通知（スレッド返信）
```
✅ 完了申請がありました
申請日時: 2025-10-04 15:00

[承認] [却下]
```

## 🗄️ データ構造

### Notionに保存するスレッド情報

タスクデータベースに以下のプロパティを追加：

| プロパティ名 | 型 | 説明 |
|-------------|-----|------|
| `依頼先スレッドTS` | Text | 依頼先のDMスレッドのタイムスタンプ |
| `依頼先スレッドチャンネル` | Text | 依頼先のDMチャンネルID |
| `依頼者スレッドTS` | Text | 依頼者のDMスレッドのタイムスタンプ |
| `依頼者スレッドチャンネル` | Text | 依頼者のDMチャンネルID |

### NotionTaskSnapshotへの追加

```python
@dataclass
class NotionTaskSnapshot:
    # ... 既存フィールド ...
    assignee_thread_ts: Optional[str]  # 依頼先スレッドTS
    assignee_thread_channel: Optional[str]  # 依頼先DMチャンネル
    requester_thread_ts: Optional[str]  # 依頼者スレッドTS
    requester_thread_channel: Optional[str]  # 依頼者DMチャンネル
```

## 🔄 実装フロー

### 1. タスク作成時（最初のメッセージ）

```python
# 1. 依頼先にDM（親メッセージ）
assignee_dm_channel = slack_service.open_dm(assignee_slack_id)
assignee_message = slack_service.send_message(
    channel=assignee_dm_channel,
    blocks=[...],  # タスク詳細
)
assignee_thread_ts = assignee_message["ts"]

# 2. 依頼者にDM（親メッセージ）
requester_dm_channel = slack_service.open_dm(requester_slack_id)
requester_message = slack_service.send_message(
    channel=requester_dm_channel,
    blocks=[...],  # 送信完了通知
)
requester_thread_ts = requester_message["ts"]

# 3. Notionにスレッド情報を保存
notion_service.save_thread_info(
    page_id=page_id,
    assignee_thread_ts=assignee_thread_ts,
    assignee_thread_channel=assignee_dm_channel,
    requester_thread_ts=requester_thread_ts,
    requester_thread_channel=requester_dm_channel,
)
```

### 2. 後続メッセージ（スレッド返信）

```python
# 1. Notionからスレッド情報を取得
snapshot = notion_service.get_task_snapshot(page_id)

# 2. 依頼先へのメッセージ（スレッド返信）
if snapshot.assignee_thread_ts:
    slack_service.send_message(
        channel=snapshot.assignee_thread_channel,
        thread_ts=snapshot.assignee_thread_ts,  # スレッドの親を指定
        blocks=[...],  # リマインド等
    )

# 3. 依頼者へのメッセージ（スレッド返信）
if snapshot.requester_thread_ts:
    slack_service.send_message(
        channel=snapshot.requester_thread_channel,
        thread_ts=snapshot.requester_thread_ts,  # スレッドの親を指定
        blocks=[...],  # 通知等
    )
```

## 📝 メッセージ内容の改善

### 親メッセージのフォーマット統一

**依頼先への親メッセージ**:
```markdown
📋 **新しいタスク依頼**

**件名**: テスト機能の実装
**依頼者**: @Gaku Masuda
**納期**: 2025-10-04 16:00
**タスク種類**: 社内タスク
**緊急度**: 最重要

**内容**:
APIエンドポイントの実装をお願いします。

---
⏳ **ステータス**: 承認待ち
先にタスクを承認してください。
```

**依頼者への親メッセージ**:
```markdown
✅ **タスク依頼を送信しました**

**件名**: テスト機能の実装
**依頼先**: @担当者名
**納期**: 2025-10-04 16:00

---
⏳ **ステータス**: 承認待ち
担当者の承認をお待ちください。
```

### スレッド返信のタイムスタンプ追加

各メッセージに絵文字+タイムスタンプを追加：
```markdown
⏰ 2025-10-03 12:00 | リマインド: まだ承認待ちです
✅ 2025-10-03 18:00 | タスクが承認されました
📅 2025-10-04 08:00 | 納期リマインド: 当日です
✅ 2025-10-04 15:00 | 完了申請がありました
🎉 2025-10-04 16:00 | タスクが完了しました
```

## 🎯 UX改善のポイント

### 1. **視認性の向上**
- 絵文字を統一的に使用（📋=タスク、⏰=リマインド、✅=完了、❌=却下）
- ステータスを常に表示
- タイムスタンプで時系列を把握

### 2. **情報の整理**
- 1タスク = 1スレッド
- DMが散らからない
- 過去のやり取りを簡単に確認可能

### 3. **操作性の向上**
- スレッド内でボタンを常に表示
- 各メッセージにアクションボタンを配置
- スレッドを開けばタスクの全履歴が見える

### 4. **通知の最適化**
- 親メッセージは必ず通知
- スレッド返信は`reply_broadcast: false`でスレッド内に留める
- 重要な更新（承認、差し戻し）のみブロードキャスト可能

## 🚀 段階的な実装計画

### Phase 1: 基盤構築
1. Notionプロパティ追加（スレッド情報）
2. NotionTaskSnapshotの拡張
3. スレッド情報保存/取得メソッドの実装

### Phase 2: タスク作成の改善
4. タスク作成時に親メッセージを両者に送信
5. スレッド情報をNotionに保存

### Phase 3: 既存メッセージのスレッド化
6. 各send_メソッドをスレッド対応に修正
7. 既存のメッセージフォーマット改善

### Phase 4: テスト＆改善
8. 動作確認
9. UX改善の微調整

## 📌 注意事項

### スレッド情報が存在しない場合の対応

**既存タスク（スレッド情報なし）**:
- 従来通り新規メッセージとして送信
- ログに警告を出力
- 次回のメッセージでスレッドを開始（親メッセージとして記録）

### DMチャンネルの扱い

- DMチャンネルIDは動的に取得（`conversations.open`）
- 初回メッセージ時にチャンネルIDを保存
- 2回目以降は保存されたチャンネルIDを使用

### エラーハンドリング

- スレッドメッセージ送信失敗時は新規メッセージとして送信
- エラーログを記録
- ユーザーには影響を与えない
