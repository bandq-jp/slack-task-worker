# Notionデータベースのプロパティ設定ガイド

## 対象データベース

承認待ちリマインド機能のために、**メインのタスク管理データベース**に2つのプロパティを追加する必要があります。

### データベースの特定方法

`.env` ファイルの `NOTION_DATABASE_ID` で指定されているデータベースが対象です。

```bash
# .env ファイルを確認
NOTION_DATABASE_ID=your-notion-database-id  # ← このデータベース
```

このデータベースは以下のプロパティをすでに持っているはずです：
- タイトル (Title)
- 納期 (Date)
- ステータス (Select)
- 依頼者 (Person)
- 依頼先 (Person)
- リマインドフェーズ (Select)
- 完了ステータス (Select)
- 延期ステータス (Select)
- など

## 追加が必要なプロパティ

以下の3つのプロパティを追加してください：

### 1. タスク承認開始日時

| 項目 | 値 |
|------|-----|
| **プロパティ名** | `タスク承認開始日時` |
| **プロパティタイプ** | **Date** |
| **説明** | タスク作成時（承認待ち開始時）の日時を記録 |

**重要**:
- プロパティ名は**完全一致**する必要があります（全角/半角、スペースに注意）
- タイプは必ず **Date** を選択してください
- このプロパティは**タスク作成時に自動的に設定**されます

### 2. 承認リマインド最終送信日時

| 項目 | 値 |
|------|-----|
| **プロパティ名** | `承認リマインド最終送信日時` |
| **プロパティタイプ** | **Date** |
| **説明** | 承認待ちリマインドを最後に送信した日時を記録 |

**重要**:
- プロパティ名は**完全一致**する必要があります（全角/半角、スペースに注意）
- タイプは必ず **Date** を選択してください

### 3. 延期申請日時

| 項目 | 値 |
|------|-----|
| **プロパティ名** | `延期申請日時` |
| **プロパティタイプ** | **Date** |
| **説明** | 延期申請を行った日時を記録（延期申請時に自動で設定） |

**重要**:
- プロパティ名は**完全一致**する必要があります（全角/半角、スペースに注意）
- タイプは必ず **Date** を選択してください

## Notionでのプロパティ追加手順

### ステップ1: データベースを開く

1. Notionを開く
2. `.env` の `NOTION_DATABASE_ID` で指定されているタスク管理データベースを開く
3. データベースが「テーブル」ビューになっていることを確認

### ステップ2: プロパティを追加

1. データベースの右端にある **「+」** ボタンをクリック（新しいプロパティを追加）
2. プロパティ名を入力: `タスク承認開始日時`
3. プロパティタイプで **「Date」** を選択
4. 「作成」をクリック

### ステップ3: 2つ目のプロパティを追加

1. 再度 **「+」** ボタンをクリック
2. プロパティ名を入力: `承認リマインド最終送信日時`
3. プロパティタイプで **「Date」** を選択
4. 「作成」をクリック

### ステップ4: 3つ目のプロパティを追加

1. 再度 **「+」** ボタンをクリック
2. プロパティ名を入力: `延期申請日時`
3. プロパティタイプで **「Date」** を選択
4. 「作成」をクリック

### ステップ5: 確認

追加後、データベースのプロパティリストに以下が表示されることを確認：

```
✅ タスク承認開始日時 (Date)
✅ 承認リマインド最終送信日時 (Date)
✅ 延期申請日時 (Date)
```

## 設定例（スクリーンショット的な説明）

```
┌─────────────────────────────────────────────────────────────┐
│ タスク管理データベース                                        │
├─────────────────────────────────────────────────────────────┤
│ プロパティ一覧:                                               │
│                                                               │
│ ✓ タイトル (Title)                                           │
│ ✓ 納期 (Date)                                               │
│ ✓ ステータス (Select)                                        │
│ ✓ 依頼者 (Person)                                           │
│ ✓ 依頼先 (Person)                                           │
│ ✓ リマインドフェーズ (Select)                                │
│ ✓ リマインド既読 (Checkbox)                                  │
│ ✓ 最終リマインド日時 (Date)                                  │
│ ✓ 完了ステータス (Select)                                    │
│ ✓ 完了申請日時 (Date)                                       │
│ ✓ 延期ステータス (Select)                                    │
│ ✓ 延期期日（申請中） (Date)                                 │
│ ✓ 延期理由（申請中） (Text)                                 │
│                                                               │
│ ← 以下の3つを追加                                            │
│                                                               │
│ ✅ タスク承認開始日時 (Date) ← 新規追加                      │
│ ✅ 承認リマインド最終送信日時 (Date) ← 新規追加              │
│ ✅ 延期申請日時 (Date) ← 新規追加                            │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## プロパティ名の正確性チェック

以下のコマンドで、コード内のプロパティ名と一致しているか確認できます：

```bash
# プロパティ名の定数を確認
grep "TASK_PROP_TASK_APPROVAL_REQUESTED_AT\|TASK_PROP_APPROVAL_REMINDER_AT\|TASK_PROP_EXTENSION_REQUESTED_AT" src/infrastructure/notion/dynamic_notion_service.py
```

出力例:
```python
TASK_PROP_TASK_APPROVAL_REQUESTED_AT = "タスク承認開始日時"
TASK_PROP_APPROVAL_REMINDER_AT = "承認リマインド最終送信日時"
TASK_PROP_EXTENSION_REQUESTED_AT = "延期申請日時"
```

**Notionのプロパティ名は、この文字列と完全一致する必要があります。**

## よくある間違い

### ❌ 間違い1: プロパティ名のタイポ

```
❌ 承認リマインド最終送信時間  （「時間」ではなく「日時」）
❌ 承認リマインド最後送信日時   （「最後」ではなく「最終」）
❌ 延期申請時刻                （「時刻」ではなく「日時」）
```

### ❌ 間違い2: プロパティタイプの間違い

```
❌ Text型を選択
❌ Created time型を選択
❌ Last edited time型を選択
```

正しくは **Date型** を選択してください。

### ❌ 間違い3: 半角/全角の間違い

```
❌ 承認リマインド最終送信日時  （全角スペースが入っている場合）
❌ 延期申請日時               （半角スペースが入っている場合）
```

## プロパティが正しく設定されているか確認する方法

### 方法1: Notionで直接確認

1. データベースを開く
2. プロパティ一覧で以下を確認:
   - `承認リマインド最終送信日時` (Date型)
   - `延期申請日時` (Date型)
3. プロパティ名をクリックして、正確な名前とタイプを確認

### 方法2: プロパティ確認スクリプトで確認

以下のスクリプトを実行して、必要なプロパティが存在するか確認できます：

```bash
uv run python tests/check_task_database_properties.py
```

出力の「必要なプロパティの確認」セクションで以下を確認：

```
✅ タスク承認開始日時: date
✅ 承認リマインド最終送信日時: date
✅ 延期申請日時: date
```

すべてに✅がついていれば、プロパティが正しく設定されています。

### 方法3: システムログで確認

システムを起動して、承認待ちリマインドが動作するか確認：

```bash
# ローカルでテスト
uv run main.py

# 別のターミナルでcronエンドポイントを手動実行
curl -X POST http://localhost:8000/slack/cron/run-reminders

# ログを確認
# エラーがなければ、プロパティが正しく設定されています
```

## プロパティが存在しない場合の動作

プロパティが存在しない場合でも、システムは動作しますが：

1. **タスク承認開始日時** がない場合:
   - タスク承認待ちリマインドが送信されない
   - タスク承認開始時刻が記録されない
   - 既存のタスクは `created_time` を使用しないため、リマインドが機能しない

2. **承認リマインド最終送信日時** がない場合:
   - 承認待ちリマインドが毎回送信される可能性がある
   - 6時間ごとの制御が正しく動作しない

3. **延期申請日時** がない場合:
   - 延期申請の承認待ちリマインドが送信されない
   - 延期申請の開始時刻が記録されない

## トラブルシューティング

### リマインドが送信されない

**確認事項**:
1. Notionでプロパティ名が完全一致しているか確認
2. プロパティタイプがDate型であることを確認
3. システムログで以下のエラーがないか確認:
   ```
   ⚠️ Failed to update approval reminder time in Notion
   ⚠️ Failed to register extension request
   ```

### エラーメッセージの例

```
⚠️ Failed to update approval reminder time in Notion:
   property '承認リマインド最終送信日時' does not exist
```

このエラーが出た場合は、プロパティ名が正確に一致していません。

## まとめ

**対象データベース**: `NOTION_DATABASE_ID` で指定されているタスク管理データベース

**追加するプロパティ**:
1. `タスク承認開始日時` (Date型) - タスク作成時に自動設定
2. `承認リマインド最終送信日時` (Date型) - リマインド送信時に自動更新
3. `延期申請日時` (Date型) - 延期申請時に自動設定

**重要ポイント**:
- プロパティ名は**完全一致**が必要
- プロパティタイプは必ず **Date** を選択
- 全角/半角、スペースに注意
- すべてのプロパティは自動的に設定されるため、手動での入力は不要

**プロパティの役割**:
- **タスク承認開始日時**: タスク承認待ちリマインドの6時間判定の基準
- **完了申請日時** (既存): 完了承認待ちリマインドの6時間判定の基準
- **延期申請日時**: 延期承認待ちリマインドの6時間判定の基準

これで承認待ちリマインド機能が正しく動作するようになります。
