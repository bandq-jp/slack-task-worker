# 承認待ちリマインド機能とタスク削除機能

## 概要

このドキュメントでは、承認待ちタスクに対する自動リマインド機能とタスク削除機能の実装について説明します。

**重要**: この機能は既存の `/cron/run-reminders` エンドポイント（1時間ごとに実行）に統合されているため、**追加のCloud Scheduler設定は不要**です。

## 機能仕様

### 1. 承認待ちリマインド機能

**対象となる承認待ち**:
1. **タスク依頼の承認待ち** - ステータスが「承認待ち」のタスク
2. **完了申請の承認待ち** - 完了ステータスが「完了申請中」のタスク
3. **延期申請の承認待ち** - 延期ステータスが「申請中」のタスク

**リマインド条件**:
- 承認待ち開始から **6時間経過** で初回リマインド送信
- 前回リマインドから **6時間経過** で再度リマインド送信
- 承認されるまで6時間ごとに繰り返しリマインド
- `/cron/run-reminders` は1時間ごとに実行されるが、6時間経過判定により実質6時間ごとに送信

**通知先**:
- **承認者**: 実際に承認ボタンを押す人（担当者 or 依頼者）
- **申請者**: 承認を待っている人（依頼者 or 担当者）

### 2. タスク削除機能

**削除条件**:
- タスクステータスが「承認待ち」の場合のみ
- **依頼者のみ**が削除可能

**削除方法**:
- 論理削除（ステータスを「無効」に変更）
- 物理的にデータは残る

**削除ボタンの表示場所**:
- タスク承認待ちリマインド（依頼者向けメッセージ）

## Notionデータベースに追加が必要なプロパティ

以下の2つのプロパティを手動で追加してください：

| プロパティ名 | タイプ | 説明 |
|-------------|--------|------|
| `承認リマインド最終送信日時` | Date | 承認待ちリマインドを最後に送信した日時 |
| `延期申請日時` | Date | 延期申請を行った日時（延期申請時に自動記録） |

**注意**: これらのプロパティが存在しない場合でもシステムは動作しますが、リマインド機能が正しく動作しません。

## 実装詳細

### アーキテクチャ

DDDとオニオンアーキテクチャに完全準拠：

```
Presentation Layer (slack_endpoints.py)
    ↓
Infrastructure Layer (DynamicNotionService, SlackService)
    ↓
Domain Layer (NotionTaskSnapshot)
```

### 主要な変更ファイル

#### 1. `src/infrastructure/notion/dynamic_notion_service.py`

**追加したプロパティ定数**:
```python
TASK_PROP_APPROVAL_REMINDER_AT = "承認リマインド最終送信日時"
TASK_PROP_EXTENSION_REQUESTED_AT = "延期申請日時"
```

**拡張した `NotionTaskSnapshot` データクラス**:
```python
@dataclass
class NotionTaskSnapshot:
    # ... 既存フィールド ...
    created_time: Optional[datetime]  # タスク作成日時（Notion標準プロパティ）
    approval_reminder_last_sent_at: Optional[datetime]  # 承認リマインド最終送信日時
    extension_requested_at: Optional[datetime]  # 延期申請日時
```

**新規メソッド**:
- `fetch_pending_approval_tasks()` - 承認待ちタスク一覧を取得
- `update_approval_reminder_time()` - 承認リマインド最終送信日時を更新
- `disable_task()` - タスクを無効化（論理削除）

**修正したメソッド**:
- `set_extension_request()` - 延期申請時に `extension_requested_at` を記録
- `_to_snapshot()` - 新しいフィールドをパース

#### 2. `src/infrastructure/slack/slack_service.py`

**新規メソッド**:
- `send_task_approval_reminder()` - タスク承認待ちリマインド送信
- `send_completion_approval_reminder()` - 完了承認待ちリマインド送信
- `send_extension_approval_reminder()` - 延期承認待ちリマインド送信

#### 3. `src/presentation/api/slack_endpoints.py`

**修正したエンドポイント**:
- `POST /cron/run-reminders` - 既存の納期リマインド処理に承認待ちリマインド処理を統合
  - 納期リマインド処理の後に承認待ちリマインド処理を実行
  - 同じ `email_cache` と `resolve_slack_id` 関数を共有
  - 返り値に以下のフィールドを追加:
    - `approval_checked`: チェックした承認待ちタスク数
    - `approval_notified`: リマインド送信した承認待ちタスク数
    - `approval_notifications`: 送信した承認待ちリマインドの詳細
    - `approval_errors`: 承認待ちリマインド処理のエラーリスト

**新規アクションハンドラー**:
- `delete_pending_task` - タスク削除ボタンのハンドラー

## Cloud Scheduler設定

**追加のスケジューラー設定は不要です。**

承認待ちリマインド機能は、既存の `/cron/run-reminders` エンドポイント（1時間ごとに実行）に統合されています。

### 動作の仕組み

1. 既存のCloud Schedulerが1時間ごとに `/cron/run-reminders` を呼び出す
2. エンドポイント内で以下を順次処理:
   - **納期リマインド処理** - 期日前、当日、超過のリマインド
   - **承認待ちリマインド処理** - 6時間経過判定してリマインド送信
3. 承認待ちリマインドは6時間経過判定を行うため、実質6時間ごとに送信される

### レスポンス例

```json
{
  "timestamp": "2025-01-10T12:00:00Z",
  "checked": 50,
  "notified": 5,
  "notifications": [...],
  "errors": [],
  "approval_checked": 12,
  "approval_notified": 3,
  "approval_notifications": [
    {
      "page_id": "abc123",
      "approval_type": "task_approval",
      "hours_elapsed": 7.5
    }
  ],
  "approval_errors": []
}
```

## 使用例

### タスク承認待ちの場合

**担当者への通知**:
```
📝 タスク承認待ちリマインド

以下のタスクの承認をお願いします。

タスク: [タスクのリンク]
依頼者: @user_name

[✅ 承認] [❌ 差し戻し]
```

**依頼者への通知**:
```
⏳ タスク承認待ち

以下のタスクがまだ承認されていません。

タスク: [タスクのリンク]
担当者: @assignee_name

[🗑️ タスク削除]
```

### 完了承認待ちの場合

**依頼者（承認者）への通知**:
```
✅ 完了承認待ちリマインド

以下のタスクの完了承認をお願いします。

タスク: [タスクのリンク]
担当者: @assignee_name
```

**担当者への通知**:
```
⏳ 完了承認待ち

以下のタスクの完了承認待ちです。

タスク: [タスクのリンク]
依頼者: @requester_name
```

### 延期承認待ちの場合

**依頼者（承認者）への通知**:
```
⏳ 延期承認待ちリマインド

以下のタスクの延期承認をお願いします。

タスク: [タスクのリンク]
担当者: @assignee_name
希望納期: 2025/01/15 10:00
理由: プロジェクト遅延のため
```

**担当者への通知**:
```
⏳ 延期承認待ち

以下のタスクの延期承認待ちです。

タスク: [タスクのリンク]
依頼者: @requester_name
希望納期: 2025/01/15 10:00
```

## エラーハンドリング

### タスク削除時のエラー

1. **権限エラー**: 依頼者以外が削除しようとした場合
   - メッセージ: "❌ タスクを削除できるのは依頼者のみです。"

2. **ステータスエラー**: 承認待ち以外のタスクを削除しようとした場合
   - メッセージ: "❌ 承認待ち状態のタスクのみ削除できます。"

3. **タスク未検出**: タスクが見つからない場合
   - メッセージ: "❌ タスクが見つかりません"

### リマインド送信時のエラー

- Slack API エラー: ログに記録し、次回リトライ
- Notion API エラー: ログに記録し、エラーリストに追加
- ユーザー未検出: ログに記録し、エラーリストに追加

## 監査ログ

以下のイベントが監査ログに記録されます：

1. **タスク承認リマインド** - 承認待ち経過時間を記録
2. **完了承認リマインド** - 承認待ち経過時間を記録
3. **延期承認リマインド** - 承認待ち経過時間を記録
4. **タスク削除** - 削除者と削除されたタスク情報を記録

## テスト方法

### 承認待ちリマインドのテスト

1. タスクを作成し、承認せずに6時間待つ
2. または、Notionで `created_time` を手動で6時間以上前に変更
3. cronエンドポイントを手動で呼び出す: `POST /slack/cron/run-reminders`
4. 担当者と依頼者の両方にリマインドが届くことを確認
5. レスポンスの以下のフィールドを確認:
   - `approval_checked` > 0
   - `approval_notified` > 0
   - `approval_notifications` に詳細情報が含まれる

### タスク削除のテスト

1. タスクを作成（承認待ち状態）
2. 依頼者として承認待ちリマインドを受信
3. 「🗑️ タスク削除」ボタンをクリック
4. 確認ダイアログで「削除する」を選択
5. タスクのステータスが「無効」になることを確認
6. 担当者に削除通知が届くことを確認

## 既存機能への影響

- 既存の納期リマインド機能（`/cron/run-reminders`）に承認待ちリマインド処理を統合
- 納期リマインドと承認待ちリマインドは同じエンドポイントで処理されるが、処理ロジックは独立
- 既存のタスク承認フローに変更なし
- 延期申請時に `extension_requested_at` が自動記録されるように拡張
- `/cron/run-reminders` の返り値に承認待ちリマインドの結果フィールドが追加（後方互換性あり）

## 実装の特徴

### シンプルで整合性のあるアーキテクチャ

1. **単一のスケジューラー**:
   - 既存の `/cron/run-reminders` のみを使用
   - 新しいスケジューラーを追加する必要がない

2. **統一されたリマインド処理**:
   - 納期リマインドと承認待ちリマインドを同じエンドポイントで処理
   - 共通の `email_cache` と `resolve_slack_id` を使用して効率化

3. **柔軟な判定ロジック**:
   - 1時間ごとに実行されるが、6時間経過判定により適切なタイミングで送信
   - 前回リマインド時刻も考慮して重複送信を防止

## 今後の拡張案

1. リマインド頻度のカスタマイズ（環境変数で設定可能に）
2. リマインド停止ボタンの追加
3. エスカレーション機能（24時間経過で管理者に通知）
4. 承認待ちタスクのダッシュボード表示

## トラブルシューティング

### リマインドが送信されない

**確認事項**:
1. Notionに以下のプロパティが存在するか確認
   - `承認リマインド最終送信日時` (Date型)
   - `延期申請日時` (Date型)
2. 承認待ち開始から6時間以上経過しているか確認
3. `/cron/run-reminders` のレスポンスで `approval_checked` が0より大きいか確認
4. cronエンドポイントのログを確認（`approval_errors` をチェック）

### タスク削除ボタンが表示されない

**確認事項**:
1. タスクステータスが「承認待ち」であることを確認
2. ユーザーが依頼者であることを確認
3. リマインドが正しく送信されているか確認

### 延期申請日時が記録されない

**確認事項**:
1. Notionに `延期申請日時` プロパティが存在するか確認
2. プロパティ名が完全一致しているか確認（全角/半角に注意）
3. プロパティタイプがDate型であることを確認
