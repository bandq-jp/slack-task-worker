# 管理者向け Notion データベース設計ガイド

このドキュメントでは、Slack/Notion タスク管理システムの新しい管理者向けメトリクス機能を利用するための Notion データベース設計と運用手順をまとめます。エンジニアリングチームがコードで参照しているプロパティ名と整合することを前提にしています。

## 構成概要

管理者向けビューは以下の2つのデータベースで構成します。

1. **タスクKPI台帳（Metrics Database）**
   - タスクごとの指標を記録します（納期超過ポイント、リマインドステージなど）。
   - 社員はアクセス不可。管理者ロールのみ閲覧・編集権限を付与します。
2. **担当者サマリー（Assignee Summary Database）**
   - 担当者単位の集計結果を保存します（担当タスク数、期限超過タスク数など）。
   - こちらも管理者専用で共有し、社員はアクセスできないようにします。

アプリケーションは `Settings` クラス（`src/presentation/api/slack_endpoints.py`）の以下環境変数を通じてデータベースIDを参照します。

- `NOTION_METRICS_DATABASE_ID`
- `NOTION_ASSIGNEE_SUMMARY_DATABASE_ID`

## 1. タスクKPI台帳（Metrics Database）

| プロパティ名 (Notion) | 種類 | 用途 / 備考 |
|-----------------------|------|-------------|
| **タスク名** | Title | タスクのタイトルを同期します。コード定数: `METRICS_PROP_TASK_TITLE` |
| **タスクID** | Rich text | 対応するタスクページID（ハイフン入り）を保存します。`METRICS_PROP_TASK_ID` |
| **担当者** | People (推奨) / Rich text | Notionアカウントと連動する場合は People、メールのみの場合は Rich text でも可。`METRICS_PROP_ASSIGNEE` |
| **担当者メール** | Rich text | メールアドレスによる冗長化。後続のサマリー集計でキーになります。`METRICS_PROP_ASSIGNEE_EMAIL` |
| **納期** | Date | タスクの納期。`METRICS_PROP_DUE` |
| **ステータス** | Select | タスクのメインステータス（承認待ち/承認済み/完了/差し戻し/無効）。`METRICS_PROP_STATUS` |
| **完了ステータス** | Select | 完了ワークフローの状態（進行中/完了申請中/完了承認 など）。`METRICS_PROP_COMPLETION_STATUS` |
| **延期ステータス** | Select | 延期申請の状態（申請中/承認済/却下/なし）。`METRICS_PROP_EXTENSION_STATUS` |
| **リマインドフェーズ** | Select | 最新のリマインド状態（期日前/当日/超過/未承認/既読など）。`METRICS_PROP_REMINDER_STAGE` |
| **納期超過ポイント** | Number | アプリが計算する社内評価用ポイント。社員には非公開。`METRICS_PROP_OVERDUE_POINTS` |
| **最終更新** | Date | メトリクス同期日時。`METRICS_PROP_LAST_SYNCED` |

### 推奨ビュー
- **全件一覧ビュー（管理者用）**: 全プロパティを表示するテーブル。
- **期限超過フィルタ**: `納期` が今日より前、かつ `ステータス` ≠ 完了 のフィルタビュー。
- **納期超過ポイント降順**: `納期超過ポイント` でソートし、高リスクタスクを可視化。

## 2. 担当者サマリー（Assignee Summary Database）

| プロパティ名 (Notion) | 種類 | 用途 / 備考 |
|-----------------------|------|-------------|
| **担当者** | People or Rich text | 担当者を可視化。`SUMMARY_PROP_ASSIGNEE` |
| **担当者メール** | Rich text | メールアドレスでの一意識別に使用。`SUMMARY_PROP_ASSIGNEE_EMAIL` |
| **担当タスク数** | Number | 現在保有しているタスク数。`SUMMARY_PROP_TOTAL_TASKS` |
| **期限超過タスク数** | Number | 今日時点で期限を超えているタスク数。`SUMMARY_PROP_OVERDUE_TASKS` |
| **近日納期タスク数** | Number | 今後3日以内に期限を迎えるタスク数。`SUMMARY_PROP_DUE_SOON_TASKS` |
| **最短納期** | Date | 今後の最も近い納期。`SUMMARY_PROP_NEXT_DUE` |
| **納期超過ポイント累計** | Number | 担当者単位での累積ポイント。`SUMMARY_PROP_TOTAL_OVERDUE_POINTS` |
| **最終更新** | Date | 集計の更新日時。`SUMMARY_PROP_LAST_UPDATED` |

### 推奨ビュー
- **担当者一覧**: テーブル形式で各集計値を表示。
- **ランキングビュー**: `納期超過ポイント累計` または `期限超過タスク数` の降順ソートで評価対象を抽出。

## 権限設定

1. **台帳/サマリーともに「管理者専用ワークスペース」内で作成**し、対象社員グループからはアクセス権限を外します。
2. システム連携用の Notion API トークンには **フルトークン（Internal Integration）** を利用し、両データベースを共有します。
3. Slack 通知で参照される「タスクワークスペース」の DB は従来通り社員と共有しても問題ありませんが、「納期超過ポイント」など敏感情報は含めない設計に変更済みです。

## 作成手順

1. **タスクKPI台帳を作成**
   - Notion で新規データベースを作成し、上記プロパティを追加。
   - API 連携で利用する Integration とデータベースを共有。
   - データベースID（URLの `.../` 以降 32桁）を控えて `.env` の `NOTION_METRICS_DATABASE_ID` へ反映。
2. **担当者サマリーを作成**
   - 同様にプロパティを設定し、Integration 共有を実施。
   - ID を `NOTION_ASSIGNEE_SUMMARY_DATABASE_ID` に設定。
3. **アクセス制御**
   - 管理者ロール／人事ロールなど、閲覧を許可したいユーザー/グループのみ閲覧許可を付与。
   - 社員ロールが誤って閲覧できないかを確認。
4. **初期同期の実行**
   - アプリケーションを再起動し、`run_reminders` を一度実行すると既存タスクが自動同期されます。
   - もしくは `TaskApplicationService` が呼ばれるタスク更新フロー（タスク作成/承認/差し戻し）を走らせて手動で同期を促進してください。

## 運用メモ

- メトリクスDBやサマリーDBはシステムからの更新が前提です。手動編集は控え、必要に応じて補助プロパティ（メモなど）を別で用意してください。
- Notion 側でプロパティ名を変更するとコードとの整合が取れなくなります。変更時は `src/infrastructure/notion/admin_metrics_service.py` の定数を合わせて修正してください。
- 本番環境と検証環境で DB を分ける場合は、`.env` を環境ごとに切り替え、Integration も別々に共有してください。

## よくある質問

- **Q. People プロパティを使うべきか?** 可能であれば People を推奨します。アプリはメールアドレスも保存するためどちらでも動作します。
- **Q. 社員が納期超過ポイントを見れないか確認するには?** 該当データベースの共有設定が「管理者のみ」になっていることを確認し、社員ロールやゲストの共有リンクを無効化してください。
- **Q. 納期超過ポイントの初期値や計算タイミングは?** 完了申請/承認、リマインド実行時にアプリが再計算し `納期超過ポイント` を更新します。リマインドで未承認状態の場合は自動的に0にリセットします。

以上を完了すると、アプリケーションから管理者専用の指標管理が可能になります。
